___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "category": ["UTILITY"],
  "__wm": "VGVtcGxhdGUtQXV0aG9yX1Jlc3BvbnNlLUhlYWRlcnMtU2ltby1BaGF2YQ==",
  "securityGroups": [],
  "displayName": "Response Headers",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "Add headers to the response set back to the request source. Use this, for example, to add CORS headers to the response.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "LABEL",
    "name": "Info",
    "displayName": "Add the response headers with the fields below. Do note that not all response headers work with all types of requests, so make sure you know what you are doing. Also, there can be \u003cstrong\u003ecollisions\u003c/strong\u003e with other tags and clients trying to set the same headers, too."
  },
  {
    "type": "GROUP",
    "name": "predefined",
    "displayName": "Predefined Headers",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "allowOrigin",
        "checkboxText": "Access-Control-Allow-Origin",
        "simpleValueType": true,
        "help": "Set this to the origin you want to allow CORS access to, or set the value to \u003cstrong\u003eauto\u003c/strong\u003e to (attempt to) match the origin of the request.",
        "subParams": [
          {
            "type": "TEXT",
            "name": "allowOriginInput",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "REGEX",
                "args": [
                  "^(http(s)?://[^/]+$|auto)$"
                ]
              }
            ],
            "enablingConditions": [
              {
                "paramName": "allowOrigin",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "valueHint": "https://www.my.origin"
          }
        ]
      },
      {
        "type": "CHECKBOX",
        "name": "allowMethods",
        "checkboxText": "Access-Control-Allow-Methods",
        "simpleValueType": true,
        "help": "Add a comma-separated list of methods you want to allow.",
        "subParams": [
          {
            "type": "TEXT",
            "name": "allowMethodsInput",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "valueHint": "GET,POST",
            "enablingConditions": [
              {
                "paramName": "allowMethods",
                "paramValue": true,
                "type": "EQUALS"
              }
            ]
          }
        ]
      },
      {
        "type": "CHECKBOX",
        "name": "allowHeaders",
        "checkboxText": "Access-Control-Allow-Headers",
        "simpleValueType": true,
        "subParams": [
          {
            "type": "TEXT",
            "name": "allowHeadersInput",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "valueHint": "content-type,x-custom-header",
            "enablingConditions": [
              {
                "paramName": "allowHeaders",
                "paramValue": true,
                "type": "EQUALS"
              }
            ]
          }
        ],
        "help": "Add a comma-separated list of headers you want to allow."
      },
      {
        "type": "CHECKBOX",
        "name": "allowCredentials",
        "checkboxText": "Access-Control-Allow-Credentials",
        "simpleValueType": true,
        "help": "Check this box if you want to allow the request to be sent with credentials."
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "custom",
    "displayName": "Custom Headers",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "customHeaders",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Header name",
            "name": "name",
            "type": "TEXT",
            "isUnique": false
          },
          {
            "defaultValue": "",
            "displayName": "Header value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "newRowButtonText": "Add Header"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const getRequestHeader = require('getRequestHeader');
const setResponseHeader = require('setResponseHeader');

const customHeaders = data.customHeaders || [];

if (data.allowOriginInput === 'auto') {
  setResponseHeader('Access-Control-Allow-Origin', getRequestHeader('origin'));
} else if (data.allowOrigin) {
  setResponseHeader('Access-Control-Allow-Origin', data.allowOriginInput);
}

if (data.allowMethodsInput) {
  setResponseHeader('Access-Control-Allow-Methods', data.allowMethodsInput);
}

if (data.allowHeadersInput) {
  setResponseHeader('Access-Control-Allow-Headers', data.allowHeadersInput);
}

if (data.allowCredentials) {
  setResponseHeader('Access-Control-Allow-Credentials', 'true');
}

customHeaders.forEach(header => {
  setResponseHeader(header.name, header.value);
});

// Call data.gtmOnSuccess when the tag is finished.
data.gtmOnSuccess();


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_response",
        "versionId": "1"
      },
      "param": [
        {
          "key": "writeResponseAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "writeHeaderAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "writeHeadersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "origin"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: All headers added to response
  code: |-
    let mockOrigin = null;

    mock('getRequestHeader', header => {
      if (header === 'origin') {
        mockOrigin = 'https://www.my.origin';
        return mockOrigin;
      }
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('setResponseHeader').wasCalledWith('Access-Control-Allow-Origin', mockOrigin);
    assertApi('setResponseHeader').wasCalledWith('Access-Control-Allow-Methods', mockData.allowMethodsInput);
    assertApi('setResponseHeader').wasCalledWith('Access-Control-Allow-Headers', mockData.allowHeadersInput);
    assertApi('setResponseHeader').wasCalledWith('Access-Control-Allow-Credentials', 'true');
    assertApi('setResponseHeader').wasCalledWith('x-test-response', 'x-test-response');
    assertApi('setResponseHeader').wasCalledWith('x-test-response-2', 'x-test-response-2');
    assertApi('gtmOnSuccess').wasCalled();
- name: Test with custom allow-origin
  code: |-
    mockData.allowOriginInput = 'https://my.origin';

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('setResponseHeader').wasCalledWith('Access-Control-Allow-Origin', mockData.allowOriginInput);
    assertApi('gtmOnSuccess').wasCalled();
setup: |-
  const mockData = {
    allowOrigin: true,
    allowOriginInput: 'auto',
    allowMethods: true,
    allowMethodsInput: 'GET,POST',
    allowHeaders: true,
    allowHeadersInput: 'x-test',
    allowCredentials: true,
    customHeaders: [{
      name: 'x-test-response',
      value: 'x-test-response'
    },{
      name: 'x-test-response-2',
      value: 'x-test-response-2'
    }]
  };


___NOTES___

Created on 03/09/2021, 09:56:02


